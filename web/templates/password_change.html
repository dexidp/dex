{{ template "header.html" . }}

<div class="theme-panel">
  <h2 class="theme-heading">Change Password</h2>
  {{ if .ChangeReason.WeakComplexity }}
    Initiator: password complexity policy
  {{ else if .ChangeReason.Rotation }}
    Initiator: password rotation policy
  {{ end }}
  <form method="post" action="{{ .ReqPath }}">
    <div class="theme-form-row">
        <div class="theme-form-label">
            <label for="username">Username</label>
        </div>
        <input type="text" id="username" name="username"
                value="{{ .Username }}" readonly
                class="theme-form-input theme-form-input-readonly">
    </div>

    <div class="theme-form-row">
      <div class="theme-form-label">
        <label for="currentPassword">Current Password</label>
      </div>
      <input tabindex="1" required id="currentPassword" name="currentPassword" type="password"
             class="theme-form-input" placeholder="current password" {{ if .Error.Exists }} autofocus {{ end }}/>
    </div>

    <div class="theme-form-row">
      <div class="theme-form-label">
        <label for="newPassword">New Password</label>
      </div>
      <input tabindex="2" required id="newPassword" name="newPassword" type="password"
             class="theme-form-input" placeholder="new password"/>
      {{ if .PasswordPolicy }}
        <pre class="theme-form-hint">{{ .PasswordPolicy.ComplexityRequirements }}</pre>
      {{ end }}
    </div>

    <div class="theme-form-row">
      <div class="theme-form-label">
        <label for="confirmPassword">Confirm New Password</label>
      </div>
      <input tabindex="3" required id="confirmPassword" name="confirmPassword" type="password"
             class="theme-form-input" placeholder="confirm new password"/>
    </div>

    {{ if .Error.Exists }}
      <div id="password-error" class="dex-error-box">
        {{ if .Error.List.CurrentPasswordInvalid }}
          Current password is incorrect
        {{ else if .Error.List.PasswordTooWeak.Exists }}
          <pre class="theme-form-hint">Password doesn't meet requirements: {{ .Error.List.PasswordTooWeak.Description }}</pre>
        {{ else if .Error.List.OldAndNewPassAreEqual }}
          Current password and new password cannot be equal
        {{ else if .Error.List.ReusedPassword }}
          Cannot use one of previous passwords
        {{ else }}
          Failed to change password
        {{ end }}
      </div>
    {{ end }}

    <button tabindex="4" id="submit-change" type="submit" class="dex-btn theme-btn--primary">
      Change Password
    </button>
  </form>
</div>

<script type="text/javascript">
  document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submit-change');

    const urlParams = new URLSearchParams(window.location.search);

    urlParams.forEach((value, key) => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = key;
        hiddenInput.value = value;
        this.appendChild(hiddenInput);
    });
  });

  // Simple client-side validation
  document.querySelector('form').addEventListener('submit', function(e) {
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (newPass !== confirmPass) {
      e.preventDefault();
      alert('New passwords do not match');
    }
  });
</script>

{{ template "footer.html" . }}